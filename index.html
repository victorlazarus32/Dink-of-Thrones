
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dink of Thrones ‚Äì Team Ladder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    body {
      background: #020617;
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 10px;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.4), rgba(15,23,42,0.95));
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    .banner {
      display: flex;
      justify-content: center;
      margin-bottom: 4px;
    }

    .banner-logo {
      max-width: 160px;
      height: auto;
      border-radius: 999px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.65);
      border: 1px solid rgba(148,163,184,0.4);
      object-fit: cover;
    }

    h1 {
      text-align: center;
      margin: 6px 0 2px 0;
      font-size: 1.6rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .sub {
      text-align: center;
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 10px;
      line-height: 1.3;
    }

    .card {
      background: rgba(2,6,23,0.92);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid rgba(31,41,55,0.9);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.6);
    }

    h3 {
      margin-top: 0;
      margin-bottom: 6px;
      font-size: 0.95rem;
    }

    .event-type {
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .event-type label {
      margin-right: 10px;
      cursor: pointer;
    }

    .event-type input[type="radio"] {
      margin-right: 4px;
    }

    .event-note {
      font-size: 0.78rem;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 9px 10px;
      margin-bottom: 6px;
      border-radius: 10px;
      border: 1px solid #374151;
      background: #020617;
      color: #f9fafb;
      box-sizing: border-box;
      font-size: 0.9rem;
      -webkit-appearance: none;
      appearance: none;
    }

    input::placeholder {
      color: #6b7280;
    }

    button {
      width: 100%;
      padding: 11px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      margin-top: 6px;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: #111827;
    }

    .btn-secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    .btn-danger {
      background: #b91c1c;
      color: #fee2e2;
    }

    .layout-2col {
      display: grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 10px;
    }

    @media (max-width: 900px) {
      .layout-2col {
        grid-template-columns: 1fr;
      }
    }

    /* Team setup block */
    .team-setup-block {
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 6px 8px;
      margin-bottom: 6px;
      background: #020617;
    }

    .team-setup-title {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    .player-row {
      display: grid;
      grid-template-columns: 1.4fr 0.8fr 1.2fr;
      gap: 6px;
      align-items: center;
      margin-bottom: 4px;
    }

    .dupr-block {
      display: block;
    }

    .court {
      background: #020617;
      border-radius: 10px;
      border: 1px solid #1f2937;
      padding: 8px;
      margin-bottom: 6px;
    }

    .court h4 {
      margin: 0 0 4px 0;
      font-size: 0.95rem;
    }

    .court-tag {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .team-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 6px;
      align-items: center;
      margin-bottom: 4px;
    }

    .team-pill {
      background: #0b1220;
      border-radius: 999px;
      padding: 6px 8px;
      border: 1px solid #1f2937;
      font-size: 0.85rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .message {
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .message-error {
      color: #fecaca;
    }

    .message-success {
      color: #bbf7d0;
    }

    .stand-team {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1f2937;
      padding: 6px 8px;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }

    .rank-badge {
      display: inline-block;
      min-width: 22px;
      text-align: center;
      border-radius: 999px;
      background: #111827;
      border: 1px solid #374151;
      font-size: 0.75rem;
      margin-right: 6px;
      padding: 2px 4px;
    }

    .rank-badge.champ {
      background: #f97316;
      border-color: #fed7aa;
      color: #111827;
    }

    .rank-badge.purg {
      background: #4b5563;
      border-color: #9ca3af;
      color: #e5e7eb;
    }

    .win {
      color: #4ade80;
      font-weight: 600;
    }

    .loss {
      color: #f97373;
      font-weight: 600;
    }

    .diff {
      color: #facc15;
      font-size: 0.78rem;
      margin-left: 6px;
    }

    .dupr-label {
      color: #9ca3af;
      font-size: 0.78rem;
      margin-left: 6px;
      display: block;
    }

    .history-round {
      font-size: 0.8rem;
    }

    .history-header {
      font-weight: 600;
      margin-bottom: 2px;
      color: #e5e7eb;
    }

    .history-item {
      color: #9ca3af;
      margin-left: 4px;
    }

    .history-winner {
      color: #4ade80;
      font-weight: 600;
    }

    .history-nav {
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .history-nav button {
      width: auto;
      padding: 5px 10px;
      font-size: 0.75rem;
      border-radius: 999px;
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    .history-nav button:disabled {
      opacity: 0.4;
    }

    .round-meta {
      font-size: 0.77rem;
      color: #9ca3af;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="banner">
      <!-- Replace src with embedded/base64 logo if desired -->
      <img src="dink-logo.png" alt="Dink of Thrones Logo" class="banner-logo" />
    </div>

    <h1>DINK OF THRONES</h1>
    <div class="sub">
      Medieval Team Ladder ‚Ä¢ 6 Courts ‚Ä¢ 12 Teams ‚Ä¢ Win % + Point Differential<br />
      Court 1 = King‚Äôs Landing ‚Ä¢ Court 6 = The Dreadfort
    </div>

    <!-- SETUP -->
    <div class="card" id="setupCard">
      <h31Ô∏è‚É£ Event Setup</h3>
      <div class="event-type">
        <label>
          <input type="radio" name="eventType" value="non-dupr" checked />
          Non-DUPR (Open Play)
        </label>
        <label>
          <input type="radio" name="eventType" value="dupr" />
          DUPR Rated Event
        </label>
      </div>
      <div id="duprNote" class="event-note" style="display:none;">
        DUPR Event: Each team has two players. Enter both players‚Äô names, ratings (1.50‚Äì8.50), and DUPR IDs. Team seeding uses the average rating.
      

      <h3>2Ô∏è‚É£ Enter Teams (12)</h3>
      <div id="teamInputs">
      <button class="btn-primary" onclick="startEvent()">Start Dink of Thrones</button>
      <div id="setupMsg" class="message"></div>
    </div>

    <div class="layout-2col">
      <div>
        <!-- COURTS -->
        <div class="card" id="courtsCard" style="display:none;">
          <h3>2Ô∏è‚É£ Round ‚Äì Enter Scores Only</h3>
          <div id="roundInfo" style="font-size:0.8rem;color:#9ca3af;margin-bottom:6px;"></div>
          <div id="roundMeta" class="round-meta"></div>
          <div id="courtsContainer"></div>
          <button class="btn-primary" onclick="applyResults()">Apply Results ‚ûú Next Round</button>
          <button class="btn-secondary" onclick="resetStats()">Reset Wins/Losses</button>
          <button class="btn-danger" onclick="undoLastRound()">Undo Last Round</button>
          <button class="btn-danger" onclick="resetEvent()">Full Reset ‚Äì New Event</button>
          <div id="roundMsg" class="message"></div>
        </div>
      </div>

      <div>
        <!-- STANDINGS -->
        <div class="card" id="standingsCard" style="display:none;">
          <h3>üèÜ House Standings</h3>
          <div id="standingsContainer"></div>
        </div>

        <!-- HISTORY -->
        <div class="card" id="historyCard" style="display:none;">
          <h3>üìú Battle History</h3>
          <div id="historyContainer"></div>
        </div>
      </div>
    </div>
  </div>
<datalist id="memberList"></datalist>
  <script src="members.js"></script>
  <script>
    var STORAGE_KEY = "dink_of_thrones_state_v4";

    var teams = [];
    var courts = [];
    var currentRound = 1;
    var roundHistory = [];
    var stateStack = [];
    var historyIndex = -1;
    var eventType = "non-dupr";
    var eventStartTime = null;

    var teamInputsDiv = document.getElementById("teamInputs");
    var setupMsg = document.getElementById("setupMsg");
    var courtsCard = document.getElementById("courtsCard");
    var courtsContainer = document.getElementById("courtsContainer");
    var standingsCard = document.getElementById("standingsCard");
    var standingsContainer = document.getElementById("standingsContainer");
    var roundInfo = document.getElementById("roundInfo");
    var roundMeta = document.getElementById("roundMeta");
    var roundMsg = document.getElementById("roundMsg");
    var historyCard = document.getElementById("historyCard");
    var historyContainer = document.getElementById("historyContainer");
    var duprNote = document.getElementById("duprNote");
    function buildTeamInputs() {
  var html = "";
  for (var i = 1; i <= 12; i++) {
    html +=
      '<div class="team-setup-block">' +
        '<div class="team-setup-title">Team ' + i + '</div>' +
        '<input type="text" id="teamName_' + i + '" placeholder="Team ' + i + ' Name" />' +
        '<div class="dupr-block" id="duprBlock_' + i + '">' +

          '<div class="player-row">' +
            '<input type="text" id="teamP1Name_' + i + '" placeholder="Player 1 Name" list="memberList" />' +
            '<input type="number" step="0.01" id="teamP1Dupr_' + i + '" placeholder="P1 DUPR" />' +
            '<input type="text" id="teamP1Id_' + i + '" placeholder="P1 DUPR ID" />' +
          '</div>' +

          '<div class="player-row">' +
            '<input type="text" id="teamP2Name_' + i + '" placeholder="Player 2 Name" list="memberList" />' +
            '<input type="number" step="0.01" id="teamP2Dupr_' + i + '" placeholder="P2 DUPR" />' +
            '<input type="text" id="teamP2Id_' + i + '" placeholder="P2 DUPR ID" />' +
          '</div>' +

        '</div>' +
      '</div>';
  }

  teamInputsDiv.innerHTML = html;
}

    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function saveState() {
      try {
        var state = {
          teams: teams,
          courts: courts,
          currentRound: currentRound,
          roundHistory: roundHistory,
          historyIndex: historyIndex,
          stateStack: stateStack,
          eventType: eventType,
          eventStartTime: eventStartTime
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn("Could not save Dink of Thrones state:", e);
      }
    }

    function loadStateIfExists() {
      try {
        var raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;

        var state = JSON.parse(raw);
        if (!state || !state.teams || !state.courts) return false;

        teams = state.teams || [];
        courts = state.courts || [];
        currentRound = state.currentRound || 1;
        roundHistory = state.roundHistory || [];
        historyIndex = (typeof state.historyIndex === "number") ? state.historyIndex : -1;
        stateStack = state.stateStack || [];
        eventType = state.eventType || "non-dupr";
        eventStartTime = state.eventStartTime || null;

        if (!teams.length || !courts.length) return false;

        var radios = document.querySelectorAll('input[name="eventType"]');
        radios.forEach(function(r) {
          r.checked = (r.value === eventType);
        });
        updateDuprVisibility();

        document.getElementById("setupCard").style.display = "none";
        courtsCard.style.display = "block";
        standingsCard.style.display = "block";
        historyCard.style.display = "block";

        renderCourts();
        renderStandings();
        renderHistory();
        renderRoundMeta();

        roundMsg.textContent = "Previous Dink of Thrones session restored.";
        roundMsg.className = "message message-success";
        return true;
      } catch (e) {
        console.warn("Could not load Dink of Thrones state:", e);
        return false;
      }
    }

    function clearSavedState() {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {
        console.warn("Could not clear Dink of Thrones state:", e);
      }
    }

    function buildTeamInputs() {
      var html = "";
      for (var i = 1; i <= 12; i++) {
        html +=
          '<div class="team-setup-block">' +
            '<div class="team-setup-title">Team ' + i + '</div>' +
            '<input type="text" id="teamName_' + i + '" placeholder="Team ' + i + ' Name" />' +
            '<div class="dupr-block" id="duprBlock_' + i + '">' +
              '<div class="player-row">' +
                '<input type="text" id="teamP1Name_' + i + '" placeholder="Player 1 Name" list="memberList" />' +
                '<input type="number" step="0.01" id="teamP1Dupr_' + i + '" placeholder="P1 DUPR" />' +
                '<input type="text" id="teamP1Id_' + i + '" placeholder="P1 DUPR ID" />' +
              '</div>' +
              '<div class="player-row">' +
                '<input type="text" id="teamP2Name_' + i + '" placeholder="Player 2 Name" list="memberList" />' +
                '<input type="number" step="0.01" id="teamP2Dupr_' + i + '" placeholder="P2 DUPR" />' +
                '<input type="text" id="teamP2Id_' + i + '" placeholder="P2 DUPR ID" />' +
              '</div>' +
            '</div>' +
          '</div>';
      }
      teamInputsDiv.innerHTML = html;
      updateDuprVisibility();
    }

    function updateDuprVisibility() {
      var radios = document.querySelectorAll('input[name="eventType"]');
      var selected = "non-dupr";
      radios.forEach(function(r) {
        if (r.checked) selected = r.value;
      });
      eventType = selected;

      var blocks = document.querySelectorAll(".dupr-block");
      if (eventType === "dupr") {
        blocks.forEach(function(el) {
          el.style.display = "block";
        });
        duprNote.style.display = "block";
      } else {
        blocks.forEach(function(el) {
          el.style.display = "none";
        });
        duprNote.style.display = "none";
      }
    }

    document.querySelectorAll('input[name="eventType"]').forEach(function(radio) {
      radio.addEventListener("change", updateDuprVisibility);
    });

    buildTeamInputs();

    function startEvent() {
      setupMsg.textContent = "";
      setupMsg.className = "message";

      teams = [];
      courts = [];
      currentRound = 1;
      roundHistory = [];
      historyIndex = -1;
      stateStack = [];

      updateDuprVisibility();

      for (var i = 1; i <= 12; i++) {
        var nameInput = document.getElementById("teamName_" + i);
        var teamName = nameInput ? nameInput.value.trim() : "";
        if (!teamName) {
          setupMsg.textContent = "Please enter all 12 team names.";
          setupMsg.className = "message message-error";
          return;
        }

        var p1Name = null, p2Name = null;
        var p1Dupr = null, p2Dupr = null;
        var p1Id = null, p2Id = null;
        var duprAvg = null;

        if (eventType === "dupr") {
          var p1NameInput = document.getElementById("teamP1Name_" + i);
          var p2NameInput = document.getElementById("teamP2Name_" + i);
          var p1DuprInput = document.getElementById("teamP1Dupr_" + i);
          var p2DuprInput = document.getElementById("teamP2Dupr_" + i);
          var p1IdInput = document.getElementById("teamP1Id_" + i);
          var p2IdInput = document.getElementById("teamP2Id_" + i);

          p1Name = p1NameInput ? p1NameInput.value.trim() : "";
          p2Name = p2NameInput ? p2NameInput.value.trim() : "";
          if (!p1Name || !p2Name) {
            setupMsg.textContent = "Please enter both player names for Team " + i + ".";
            setupMsg.className = "message message-error";
            return;
          }

          var rawP1 = parseFloat(p1DuprInput.value);
          var rawP2 = parseFloat(p2DuprInput.value);
          if (isNaN(rawP1) || isNaN(rawP2) || rawP1 < 1.5 || rawP1 > 8.5 || rawP2 < 1.5 || rawP2 > 8.5) {
            setupMsg.textContent =
              "Please enter valid DUPR ratings (1.50‚Äì8.50) for both players on Team " + i + ".";
            setupMsg.className = "message message-error";
            return;
          }

          p1Dupr = rawP1;
          p2Dupr = rawP2;
          duprAvg = (p1Dupr + p2Dupr) / 2;

          p1Id = p1IdInput ? p1IdInput.value.trim() : "";
          p2Id = p2IdInput ? p2IdInput.value.trim() : "";
          if (!p1Id || !p2Id) {
            setupMsg.textContent = "Please enter DUPR IDs for both players on Team " + i + ".";
            setupMsg.className = "message message-error";
            return;
          }
        }

        teams.push({
          id: "t" + i,
          name: teamName,
          wins: 0,
          losses: 0,
          pointsFor: 0,
          pointsAgainst: 0,
          dupr: duprAvg,        // team average
          p1Name: p1Name,
          p1Dupr: p1Dupr,
          p1Id: p1Id,
          p2Name: p2Name,
          p2Dupr: p2Dupr,
          p2Id: p2Id
        });
      }

      eventStartTime = new Date().toISOString();

      var seeding = teams.slice();
      if (eventType === "dupr") {
        seeding.sort(function(a, b) {
          var da = (typeof a.dupr === "number") ? a.dupr : 0;
          var db = (typeof b.dupr === "number") ? b.dupr : 0;
          return db - da;
        });
      }

      courts = [
        [seeding[0].id, seeding[1].id],
        [seeding[2].id, seeding[3].id],
        [seeding[4].id, seeding[5].id],
        [seeding[6].id, seeding[7].id],
        [seeding[8].id, seeding[9].id],
        [seeding[10].id, seeding[11].id]
      ];

      document.getElementById("setupCard").style.display = "none";
      courtsCard.style.display = "block";
      standingsCard.style.display = "block";
      historyCard.style.display = "block";

      renderCourts();
      renderStandings();
      renderHistory();
      renderRoundMeta();
      saveState();
    }

    function getTeamById(id) {
      for (var i = 0; i < teams.length; i++) {
        if (teams[i].id === id) return teams[i];
      }
      return null;
    }

    function sortTeams(a, b) {
      var gamesA = a.wins + a.losses;
      var gamesB = b.wins + b.losses;
      var pctA = gamesA > 0 ? a.wins / gamesA : 0;
      var pctB = gamesB > 0 ? b.wins / gamesB : 0;

      if (pctB !== pctA) return pctB - pctA;
      if (b.wins !== a.wins) return b.wins - a.wins;

      var diffA = a.pointsFor - a.pointsAgainst;
      var diffB = b.pointsFor - b.pointsAgainst;
      if (diffB !== diffA) return diffB - diffA;

      if (a.losses !== b.losses) return a.losses - b.losses;
      return 0;
    }

    function formatStartTime() {
      if (!eventStartTime) return "";
      try {
        var d = new Date(eventStartTime);
        if (isNaN(d.getTime())) return "";
        var optsDate = { month: "short", day: "numeric" };
        var optsTime = { hour: "numeric", minute: "2-digit" };
        return d.toLocaleDateString(undefined, optsDate) + " ‚Ä¢ " +
               d.toLocaleTimeString(undefined, optsTime);
      } catch (e) {
        return "";
      }
    }

    function renderRoundMeta() {
      var typeLabel = (eventType === "dupr") ? "DUPR Rated Event" : "Non-DUPR (Open Play)";
      var startLabel = formatStartTime();
      var parts = [];
      parts.push("Type: " + typeLabel);
      if (startLabel) {
        parts.push("Started: " + startLabel);
      }
      roundMeta.textContent = parts.join(" | ");
    }

    function renderCourts() {
      roundInfo.textContent =
        "Round " + currentRound +
        " ‚Äì enter both scores (no ties). Climb from King‚Äôs Landing to avoid The Dreadfort.";

      var html = "";
      for (var i = 0; i < courts.length; i++) {
        var pair = courts[i];
        var t1 = getTeamById(pair[0]);
        var t2 = getTeamById(pair[1]);
        if (!t1 || !t2) continue;

        var tag = "";
        if (i === 0) tag = '<span class="court-tag">King‚Äôs Landing (Champion Court)</span>';
        else if (i === 1) tag = '<span class="court-tag">Winterfell</span>';
        else if (i === 2) tag = '<span class="court-tag">Dragonstone</span>';
        else if (i === 3) tag = '<span class="court-tag">The Vale</span>';
        else if (i === 4) tag = '<span class="court-tag">The Riverlands</span>';
        else if (i === 5) tag = '<span class="court-tag">The Dreadfort (Lowest Court)</span>';

        html +=
          '<div class="court">' +
            '<h4>Court ' + (i + 1) + ' ' + tag + '</h4>' +
            '<div class="team-row">' +
              '<div class="team-pill"><span>' + escapeHtml(t1.name) + '</span></div>' +
              '<input type="number" min="0" id="score_' + i + '_a" placeholder="Score" />' +
            '</div>' +
            '<div class="team-row">' +
              '<div class="team-pill"><span>' + escapeHtml(t2.name) + '</span></div>' +
              '<input type="number" min="0" id="score_' + i + '_b" placeholder="Score" />' +
            '</div>' +
          '</div>';
      }
      courtsContainer.innerHTML = html;
      roundMsg.textContent = "";
      roundMsg.className = "message";
      renderRoundMeta();
    }

    function applyResults() {
      roundMsg.textContent = "";
      roundMsg.className = "message";

      var snapshot = {
        currentRound: currentRound,
        teams: JSON.parse(JSON.stringify(teams)),
        courts: JSON.parse(JSON.stringify(courts)),
        roundHistory: JSON.parse(JSON.stringify(roundHistory)),
        historyIndex: historyIndex,
        eventType: eventType,
        eventStartTime: eventStartTime
      };
      stateStack.push(snapshot);

      var matches = [];

      for (var i = 0; i < courts.length; i++) {
        var scoreAInput = document.getElementById("score_" + i + "_a");
        var scoreBInput = document.getElementById("score_" + i + "_b");

        if (!scoreAInput || !scoreBInput) continue;

        var scoreA = parseInt(scoreAInput.value, 10);
        var scoreB = parseInt(scoreBInput.value, 10);

        if (isNaN(scoreA) || isNaN(scoreB)) {
          roundMsg.textContent = "Enter scores for all courts.";
          roundMsg.className = "message message-error";
          stateStack.pop();
          return;
        }

        var pair = courts[i];
        var teamA = getTeamById(pair[0]);
        var teamB = getTeamById(pair[1]);
        if (!teamA || !teamB) {
          roundMsg.textContent = "Invalid team on Court " + (i + 1) + ".";
          roundMsg.className = "message message-error";
          stateStack.pop();
          return;
        }

        if (scoreA === scoreB) {
          roundMsg.textContent = "No ties allowed on Court " + (i + 1) + ".";
          roundMsg.className = "message message-error";
          stateStack.pop();
          return;
        }

        var winner, loser, winnerScore, loserScore;
        if (scoreA > scoreB) {
          winner = teamA;
          loser = teamB;
          winnerScore = scoreA;
          loserScore = scoreB;
        } else {
          winner = teamB;
          loser = teamA;
          winnerScore = scoreB;
          loserScore = scoreA;
        }

        winner.wins += 1;
        loser.losses += 1;

        winner.pointsFor += winnerScore;
        winner.pointsAgainst += loserScore;
        loser.pointsFor += loserScore;
        loser.pointsAgainst += winnerScore;

        matches.push({
          court: i + 1,
          teamA: teamA.name,
          teamB: teamB.name,
          scoreA: scoreA,
          scoreB: scoreB,
          winner: winner.name
        });
      }

      roundHistory.push({
        round: currentRound,
        matches: matches
      });
      historyIndex = roundHistory.length - 1;

      var sorted = teams.slice().sort(sortTeams);

      courts = [];
      for (var c = 0; c < 6; c++) {
        var t1 = sorted[2 * c];
        var t2 = sorted[2 * c + 1];
        if (t1 && t2) {
          courts.push([t1.id, t2.id]);
        }
      }

      currentRound += 1;

      renderCourts();
      renderStandings();
      renderHistory();
      saveState();

      roundMsg.textContent = "Results applied. Houses move across the realm.";
      roundMsg.className = "message message-success";
    }

    function renderStandings() {
      var sorted = teams.slice().sort(sortTeams);
      var html = "";

      for (var i = 0; i < sorted.length; i++) {
        var t = sorted[i];
        var games = t.wins + t.losses;
        var pct = games > 0 ? ((t.wins / games) * 100).toFixed(1) + "%" : "-";
        var diff = t.pointsFor - t.pointsAgainst;
        var diffStr = diff > 0 ? "+" + diff : diff.toString();

        var badgeClass = "rank-badge";
        if (i === 0) badgeClass += " champ";
        if (i === sorted.length - 1) badgeClass += " purg";

        var duprLine = "";
        if (eventType === "dupr" && typeof t.dupr === "number") {
          var parts = [];
          parts.push("Team DUPR " + t.dupr.toFixed(2));

          if (t.p1Name && typeof t.p1Dupr === "number") {
            parts.push(escapeHtml(t.p1Name) + " " + t.p1Dupr.toFixed(2));
          }
          if (t.p2Name && typeof t.p2Dupr === "number") {
            parts.push(escapeHtml(t.p2Name) + " " + t.p2Dupr.toFixed(2));
          }

          duprLine =
            '<span class="dupr-label">' +
              parts.join(" ‚Ä¢ ") +
            "</span>";
        }

        html +=
          '<div class="stand-team">' +
            '<div>' +
              '<span class="' + badgeClass + '">' + (i + 1) + '</span>' +
              escapeHtml(t.name) +
              duprLine +
            '</div>' +
            '<div>' +
              '<span class="win">' + t.wins + 'W</span>' +
              '<span class="loss"> ' + t.losses + 'L</span>' +
              '<span style="color:#9ca3af; margin-left:6px; font-size:0.78rem;">' + pct + '</span>' +
              '<span class="diff">' + diffStr + '</span>' +
            '</div>' +
          '</div>';
      }

      standingsContainer.innerHTML = html;
    }

    function renderHistory() {
      if (!roundHistory.length) {
        historyContainer.innerHTML =
          '<div style="font-size:0.8rem;color:#9ca3af;">No battles fought yet.</div>';
        return;
      }

      if (historyIndex < 0 || historyIndex >= roundHistory.length) {
        historyIndex = roundHistory.length - 1;
      }

      var r = roundHistory[historyIndex];
      var total = roundHistory.length;

      var html = '';

      html += '<div class="history-nav">' +
                '<button type="button" onclick="prevHistory()" ' +
                  (historyIndex === 0 ? 'disabled' : '') +
                '>Previous Round</button>' +
                '<div style="flex:1;text-align:center;font-size:0.78rem;color:#9ca3af;">' +
                   'Viewing Round ' + (historyIndex + 1) + ' of ' + total +
                '</div>' +
                '<button type="button" onclick="nextHistory()" ' +
                  (historyIndex === total - 1 ? 'disabled' : '') +
                '>Next Round</button>' +
              '</div>';

      html += '<div class="history-round">' +
                '<div class="history-header">Round ' + r.round + '</div>';

      for (var j = 0; j < r.matches.length; j++) {
        var m = r.matches[j];
        html +=
          '<div class="history-item">' +
            'Court ' + m.court + ': ' + escapeHtml(m.teamA) + ' (' + m.scoreA + ') vs ' +
            escapeHtml(m.teamB) + ' (' + m.scoreB + ') ‚Äì ' +
            '<span class="history-winner">' + escapeHtml(m.winner) + '</span>' +
          '</div>';
      }
      html += '</div>';

      historyContainer.innerHTML = html;
    }

    function prevHistory() {
      if (historyIndex > 0) {
        historyIndex--;
        renderHistory();
        saveState();
      }
    }

    function nextHistory() {
      if (historyIndex < roundHistory.length - 1) {
        historyIndex++;
        renderHistory();
        saveState();
      }
    }

    function resetStats() {
      if (!teams.length) return;
      var ok = window.confirm(
        "Reset all wins, losses, points, and history? This keeps current court matchups and team names but restarts at Round 1."
      );
      if (!ok) return;

      for (var i = 0; i < teams.length; i++) {
        teams[i].wins = 0;
        teams[i].losses = 0;
        teams[i].pointsFor = 0;
        teams[i].pointsAgainst = 0;
      }

      currentRound = 1;
      roundHistory = [];
      historyIndex = -1;
      stateStack = [];

      renderCourts();
      renderStandings();
      renderHistory();
      saveState();

      roundMsg.textContent = "All stats and history reset. A new age begins.";
      roundMsg.className = "message message-success";
    }

    function resetEvent() {
      var ok = window.confirm(
        "This will clear ALL team names, players, scores, and history and start a brand new Dink of Thrones event.\n\nAre you sure you want to reset and start from the beginning?"
      );
      if (!ok) return;

      teams = [];
      courts = [];
      currentRound = 1;
      roundHistory = [];
      historyIndex = -1;
      stateStack = [];
      eventType = "non-dupr";
      eventStartTime = null;

      clearSavedState();

      document.getElementById("setupCard").style.display = "block";
      courtsCard.style.display = "none";
      standingsCard.style.display = "none";
      historyCard.style.display = "none";

      var radios = document.querySelectorAll('input[name="eventType"]');
      radios.forEach(function(r) {
        r.checked = (r.value === "non-dupr");
      });

      buildTeamInputs();

      setupMsg.textContent = "All data cleared. Enter new teams to start a fresh Dink of Thrones event.";
      setupMsg.className = "message message-success";

      roundMsg.textContent = "";
      roundMsg.className = "message";
    }

    function undoLastRound() {
      if (!stateStack.length) {
        roundMsg.textContent = "No previous round to undo.";
        roundMsg.className = "message message-error";
        return;
      }

      var prev = stateStack.pop();
      teams = prev.teams;
      courts = prev.courts;
      roundHistory = prev.roundHistory;
      currentRound = prev.currentRound;
      historyIndex = prev.historyIndex;
      eventType = prev.eventType || "non-dupr";
      eventStartTime = prev.eventStartTime || eventStartTime;

      var radios = document.querySelectorAll('input[name="eventType"]');
      radios.forEach(function(r) {
        r.checked = (r.value === eventType);
      });
      updateDuprVisibility();

      renderCourts();
      renderStandings();
      renderHistory();
      saveState();

      roundMsg.textContent = "Last round undone. The realm rewinds.";
      roundMsg.className = "message message-success";
    }
function populateMemberList() {
  var dl = document.getElementById("memberList");
  if (!dl || !window.DINK_MEMBERS) return;

  var options = "";
  for (var i = 0; i < DINK_MEMBERS.length; i++) {
    var name = DINK_MEMBERS[i];
    options += '<option value="' + String(name)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;") +
      '"></option>';
  }
  dl.innerHTML = options;
}

function init() {
  // 1) load names for autocomplete
  populateMemberList();

  // 2) build the 12 team input blocks on the setup screen
  buildTeamInputs();

  // 3) try to restore prior state if it exists
  var restored = loadStateIfExists();
  if (!restored) {
    // fresh start: show the setup screen so you can enter teams
    showCard("setupCard");
  }
}

// Run init after the page is fully loaded (more reliable, especially on iPhone)
window.addEventListener("load", init);
</script>
</body>
</html>










